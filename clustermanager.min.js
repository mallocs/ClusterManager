ClusterManager=function(map,opts){var me=this;opts=opts||{};this.map=map;this.setMap(map);this.resetManager(opts);this.setPrecision(this.zoomToPrecision(this.map.getZoom()));google.maps.event.addDomListener(map,"dragstart",function(){me.mapDragging=true});google.maps.event.addDomListener(map,"dragend",function(){me.mapDragging=false;me._onMapMoveEnd()});google.maps.event.addDomListener(map,"center_changed",function(){if(!me.mapDragging)me._onMapMoveEnd()});google.maps.event.addDomListener(map,"zoom_changed",function(){me._onMapMoveEnd()});if(typeof opts.markers!=="undefined")this.addMarkers(opts.markers)};ClusterManager.prototype=new google.maps.OverlayView;ClusterManager.prototype.onAdd=function(){this.ready_=true;google.maps.event.trigger(this,"ready_")};ClusterManager.prototype.draw=function(){};ClusterManager.prototype.resetManager=function(opts){this.markers={};this.clusters={};this.cluster_fns={};this.cluster_meta={};var precision=opts.precision>=0&&opts.precision<=27?opts.precision:2;opts=ClusterManager.applyDefaults({padding:200,visualize:false,zoom_to_precision:function(zoom_level){return zoom_level+precision},cluster_by_distance:true,cluster_distance_factor:2048e3,icon_color:"00CC00"},opts);this.opts=opts};ClusterManager.prototype.setPrecision=function(precision){if(precision>=50||precision<0)return;this.current_precision_=precision;this.clear();if(typeof this.clusters[precision]==="undefined"){var markers=this.getMarkers();for(var i=0,length=markers.length;i<length;i++){var marker=markers[i];if(this.getMarkerMeta(marker).subtype!=="cluster"){this.addToCluster(marker,this.getMarkerMeta(marker).type,precision)}}}this.cluster();this.updateMarkers()};ClusterManager.prototype.getPrecision=function(){return this.current_precision_};ClusterManager.prototype.getGeohash=function(lat,lng,precision){lat=Math.min(lat,90);lat=Math.max(lat,-90);lng=Math.abs((lng+180)%360)-180;if(precision<=0)return"";var max_power=12;var latBase=parseInt((lat+90)*Math.pow(10,max_power)).toString(2);var lngBase=parseInt((lng+180)*Math.pow(10,max_power)).toString(2);var fortyninezeros="0000000000000000000000000000000000000000000000000";var latHash=fortyninezeros.substr(0,49-latBase.length)+latBase;var lngHash=fortyninezeros.substr(0,49-lngBase.length)+lngBase;var geohash=latHash.substr(0,precision)+lngHash.substr(0,precision);return geohash};ClusterManager.prototype.geohashGetLatLngBounds=function(geohash){var max_power=12;var precision=this.geohashGetPrecision(geohash);var fortyninezeros="0000000000000000000000000000000000000000000000000";var latMinHashBin=geohash.substr(0,precision)+fortyninezeros.substr(0,49-precision);var lngMinHashBin=geohash.substr(precision,geohash.length)+fortyninezeros.substr(0,49-precision);var fortynineones="1111111111111111111111111111111111111111111111111";var latMaxHashBin=geohash.substr(0,precision)+fortynineones.substr(0,49-precision);var lngMaxHashBin=geohash.substr(precision,geohash.length)+fortynineones.substr(0,49-precision);var latMinHashDec=parseInt(latMinHashBin,2);var lngMinHashDec=parseInt(lngMinHashBin,2);var latMaxHashDec=parseInt(latMaxHashBin,2);var lngMaxHashDec=parseInt(lngMaxHashBin,2);var latMin=Math.max(-90,latMinHashDec/Math.pow(10,max_power)-90);var lngMin=Math.max(-180,lngMinHashDec/Math.pow(10,max_power)-180);var latMax=Math.min(90,latMaxHashDec/Math.pow(10,max_power)-90);var lngMax=Math.min(180,lngMaxHashDec/Math.pow(10,max_power)-180);return new google.maps.LatLngBounds(new google.maps.LatLng(latMin,lngMin),new google.maps.LatLng(latMax,lngMax))};ClusterManager.prototype.geohashGetPrecision=function(geohash){var precision=geohash.length/2;if(parseInt(precision)!==precision||precision<0||precision>=50)return undefined;return precision};ClusterManager.prototype.getNeighborBoxes=function(box_str,type){var bounds=this.geohashGetLatLngBounds(box_str);var precision=this.geohashGetPrecision(box_str);var boxString1=this.getGeohash(bounds.getSouthWest().lat()+1e-4,bounds.getSouthWest().lng()-1e-4,precision);var boxString2=this.getGeohash(bounds.getSouthWest().lat()-1e-4,bounds.getSouthWest().lng()+1e-4,precision);var boxString3=this.getGeohash(bounds.getNorthEast().lat()+1e-4,bounds.getNorthEast().lng()-1e-4,precision);var boxString4=this.getGeohash(bounds.getNorthEast().lat()-1e-4,bounds.getNorthEast().lng()+1e-4,precision);var boxString5=this.getGeohash(bounds.getSouthWest().lat()+1e-4,bounds.getSouthWest().lng()+1e-4,precision);var boxString6=this.getGeohash(bounds.getSouthWest().lat()-1e-4,bounds.getSouthWest().lng()-1e-4,precision);var boxString7=this.getGeohash(bounds.getNorthEast().lat()+1e-4,bounds.getNorthEast().lng()+1e-4,precision);var boxString8=this.getGeohash(bounds.getNorthEast().lat()-1e-4,bounds.getNorthEast().lng()-1e-4,precision);var boxStrings=[boxString1,boxString2,boxString3,boxString4,boxString5,boxString6,boxString7,boxString8];for(var i=0,neighbors=[],boxString;boxString=boxStrings[i];i++){if(typeof this.clusters[precision][type][boxString]!=="undefined"&&boxString!==box_str){neighbors.push(boxString)}}return neighbors};ClusterManager.prototype.boxToPolygon=function(geohash,opts){opts=ClusterManager.applyDefaults({map:this.map,strokeColor:"#f33f00",strokeWeight:5,strokeOpacity:1,fillColor:"#ff0000",fillOpacity:.2},opts);var bounds=this.geohashGetLatLngBounds(geohash);var ne=bounds.getNorthEast();var sw=bounds.getSouthWest();var polygon=new google.maps.Polygon({paths:opts.paths||[ne,new google.maps.LatLng(ne.lat(),sw.lng()),sw,new google.maps.LatLng(sw.lat(),ne.lng()),ne],strokeColor:opts.strokeColor,strokeWeight:opts.strokeWeight,strokeOpacity:opts.strokeOpacity,fillColor:opts.fillColor,fillOpacity:opts.fillOpacity,map:opts.map});return polygon};ClusterManager.prototype.boxInBounds=function(geohash,bounds,padding){var newBounds=new google.maps.LatLngBounds(this.map.getBounds().getSouthWest(),this.map.getBounds().getNorthEast());if(typeof padding!=="undefined"){var proj=this.map.getProjection();var scale=Math.pow(2,this.map.getZoom());var pixelOffset=new google.maps.Point(padding/scale||0,padding/scale||0);var nePoint=proj.fromLatLngToPoint(bounds.getNorthEast());var swPoint=proj.fromLatLngToPoint(bounds.getSouthWest());var newNEPoint=new google.maps.Point(nePoint.x+pixelOffset.x,nePoint.y-pixelOffset.y);var newSWPoint=new google.maps.Point(swPoint.x-pixelOffset.x,swPoint.y+pixelOffset.y);var newNE=proj.fromPointToLatLng(newNEPoint);var newSW=proj.fromPointToLatLng(newSWPoint);newBounds.extend(newNE);newBounds.extend(newSW)}var boxBounds=this.geohashGetLatLngBounds(geohash);if(newBounds.contains(boxBounds.getNorthEast())||newBounds.contains(boxBounds.getSouthWest())||boxBounds.toSpan().lat()==180)return true;else return false};ClusterManager.prototype.addMarkers=function(markers,type,subtype){if(Object.prototype.toString.call(markers)==="[object Array]"){for(var i=0,length=markers.length;i<length;i++){var marker=markers[i];this.addMarker(marker,{type:type,subtype:subtype})}}};ClusterManager.prototype.addMarker=function(marker,opts){if(typeof opts==="undefined")opts=this.getMarkerMeta(marker);var defaults={type:"generic",subtype:"generic",hidden:true,visible:false};opts=ClusterManager.applyDefaults(defaults,opts);var type=opts.type,subtype=opts.subtype;if(typeof this.markers[type]==="undefined"){this.markers[type]={};this.cluster_meta[type]={count:{total:0,visible:0,cluster:0}}}if(typeof this.cluster_fns[type]==="undefined"){this.setClusterFn(type,this.createClusterMarker)}if(typeof this.markers[type][subtype]==="undefined"){this.markers[type][subtype]=[]}this.markers[type][subtype].push(marker);if(subtype!=="cluster"){this.cluster_meta[type]["count"]["total"]+=1;this.addToCluster(marker,type,this.getPrecision())}if(typeof opts.summary==="undefined"){var capType=opts.type.charAt(0).toUpperCase()+opts.type.slice(1);opts.summary=typeof marker.getTitle()==="undefined"?capType+" marker "+this.count(opts.type,"total"):marker.getTitle()}this.setMarkerMeta(marker,opts)};ClusterManager.prototype.count=function(type,count_type){return this.cluster_meta[type]["count"][count_type]};ClusterManager.prototype.addToCluster=function(marker,type,precision,geohash){var clusters=this.clusters;var markerLL=marker.getPosition();var markerLat=markerLL.lat();var markerLng=markerLL.lng();if(typeof clusters[precision]==="undefined"){clusters[precision]={}}if(typeof clusters[precision][type]==="undefined"){clusters[precision][type]={}}var cluster=clusters[precision][type];if(typeof geohash==="undefined"){geohash=this.getGeohash(markerLat,markerLng,precision)}if(typeof cluster[geohash]!=="undefined"){cluster[geohash]["markers"].push(marker);var length=cluster[geohash]["markers"].length;var lat=(length-1)/length*cluster[geohash]["center"][0]+markerLat/length;var lng=(length-1)/length*cluster[geohash]["center"][1]+markerLng/length;cluster[geohash]["center"]=[lat,lng]}else{cluster[geohash]={cluster:false,markers:[marker],center:[markerLat,markerLng]}}};ClusterManager.prototype.removeFromCluster=function(marker,geohash){var precision=this.geohashGetPrecision(geohash);var type=this.getMarkerMeta(marker).type;var geoBox=this.clusters[precision][type][geohash];if(geoBox["markers"].length===1){delete this.clusters[precision][type][geohash]}else if(geoBox["markers"].length>1){for(var i=0,new_markers=[],center_lat=0,center_lng=0,test_marker;test_marker=geoBox["markers"][i];i++){if(test_marker!==marker){new_markers.push(test_marker);center_lat=center_lat+test_marker.getPosition().lat();center_lng=center_lng+test_marker.getPosition().lng()}}center_lat=center_lat/new_markers.length;center_lng=center_lng/new_markers.length;geoBox["center"]=[center_lat,center_lng];geoBox["markers"]=new_markers;geoBox["cluster"]=false;this.clusters[precision][type][geohash]=geoBox}};ClusterManager.prototype.combineBoxes=function(box_str1,box_str2,type){var precision=this.geohashGetPrecision(box_str1);if(this.clusters[precision][type][box_str1]["markers"].length<this.clusters[precision][type][box_str2]["markers"].length){var temp=box_str1;box_str1=box_str2;box_str2=temp}var length=this.clusters[precision][type][box_str2]["markers"].length;for(var i=length-1,marker;i>=0;i--){marker=this.clusters[precision][type][box_str2]["markers"][i];this.removeFromCluster(marker,box_str2);this.addToCluster(marker,type,precision,box_str1)}};ClusterManager.prototype.combineClustersByDistance=function(type){var precision=this.getPrecision();var clusters=this.clusters;var clusterDistanceFactor=this.opts.cluster_distance_factor||2048e3;for(var boxStr in clusters[precision][type]){var neighbors=this.getNeighborBoxes(boxStr,type);var distance=clusterDistanceFactor*Math.pow(2,-precision+2);var clusterCenter=clusters[precision][type][boxStr]["center"];for(var j=0,result=0,neighborStr;neighborStr=neighbors[j];j++){var clusterCenter=clusters[precision][type][boxStr]["center"];var neighborCenter=clusters[precision][type][neighborStr]["center"];var currentDist=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(clusterCenter[0],clusterCenter[1]),new google.maps.LatLng(neighborCenter[0],neighborCenter[1]));if(currentDist<distance){result=j;distance=currentDist}}if(result){neighborStr=neighbors[result];this.combineBoxes(boxStr,neighborStr,type)}}};ClusterManager.prototype.cluster=function(type){var precision=this.getPrecision();if(typeof type==="undefined"){var clusters=this.clusters[precision];for(var type in clusters){this.cluster(type)}return}if(typeof this.markers[type]==="undefined")return;if(typeof this.markers[type]["cluster"]!=="undefined"){for(var i=0,marker;marker=this.markers[type]["cluster"][i];i++){marker.setVisible(false)}}this.markers[type]["cluster"]=[];this.cluster_meta[type]["count"]["cluster"]=0;var clusters=this.clusters;if(this.opts.cluster_by_distance)this.combineClustersByDistance(type);for(var boxStr in clusters[precision][type]){if(this.opts.visualize)this.boxToPolygon(boxStr).setMap(this.map);var cluster=clusters[precision][type][boxStr];for(var i=0,cluster_markers=[];marker=cluster["markers"][i];i++){var meta=this.getMarkerMeta(marker);if(typeof meta.hidden==="undefined"||!meta.hidden){cluster_markers.push(marker)}}if(cluster_markers.length>1){cluster["cluster"]=this.cluster_fns[type](cluster_markers,cluster["center"][0],cluster["center"][1],this);this.addMarker(cluster["cluster"],{type:type,subtype:"cluster",hidden:false});this.cluster_meta[type]["count"]["cluster"]+=1}else{cluster["cluster"]=false}}};ClusterManager.prototype.getMarkers=function(type,subtype,visible){var markers=[];if(this.markers==={})return[];if(typeof type==="undefined"){for(var type in this.markers){for(var subtype in this.markers[type]){markers=markers.concat(this.markers[type][subtype])}}}else if(typeof subtype==="undefined"){for(var subtype in this.markers[type]){markers=markers.concat(this.markers[type][subtype])}}else{try{markers=this.markers[type][subtype]||[]}catch(err){markers=[]}}if(typeof visible==="undefined")return markers;for(var i=0,final_markers=[],length=markers.length;i<length;i++){var marker=markers[i];var meta=this.getMarkerMeta(marker);if(visible==="all"||meta.hidden!==visible&&meta.visible==visible&&typeof marker!=="function"&&meta.type!=="cluster"){final_markers.push(marker)}}return final_markers};ClusterManager.prototype._onMapMoveEnd=function(){var me=this;if(typeof me.moveTimeout!=="undefined"){clearTimeout(me.moveTimeout);delete me.moveTimeout}var precision=me.zoomToPrecision(me.map.getZoom());if(me.getPrecision()!==precision){me.setPrecision(precision)}else{me.moveTimeout=setTimeout(function(){delete me.moveTimeout;me.updateMarkers()},100)}};ClusterManager.prototype.show=function(type,subtype){this._showHide(type,subtype,false)};ClusterManager.prototype.hide=function(type,subtype){this._showHide(type,subtype,true)};ClusterManager.prototype._showHide=function(type,subtype,hide){var me=this;var markers=this.getMarkers(type,subtype);for(var i=0,length=markers.length;i<length;i++){var marker=markers[i];this.getMarkerMeta(marker).hidden=hide}if(this.ready_)this._lagUpdate(type);else{google.maps.event.addListenerOnce(this,"ready_",function(){me._lagUpdate(type)})}};ClusterManager.prototype._lagUpdate=function(type){var me=this;if(typeof this.processingTimeout!=="undefined"){clearTimeout(me.processingTimeout);delete me.processingTimeout}this.processingTimeout=setTimeout(function(){delete me.processingTimeout;me.clear(type);me.cluster(type);me.updateMarkers()},100)};ClusterManager.prototype.reset=function(type){if(typeof type==="undefined"){var clusters=this.clusters[this.getPrecision()];for(var type in clusters){this.reset(type)}return}this.clear(type);for(var precision in this.clusters){delete this.clusters[precision][type];this.clusters[precision][type]={}}delete this.markers[type];this.markers[type]={}};ClusterManager.prototype.clear=function(type){var markers=this.getMarkers(type);for(var i=0,length=markers.length;i<length;i++){var marker=markers[i];marker.setMap(null);this.getMarkerMeta(marker).visible=false}if(typeof type!=="undefined"){this.cluster_meta[type]["count"]["visible"]=0}else{for(var item in this.cluster_meta){this.cluster_meta[item]["count"]["visible"]=0}}};ClusterManager.prototype.zoomToPrecision=function(zoom_level){return this.opts.zoom_to_precision(zoom_level)};ClusterManager.prototype.updateMarkers=function(){var precision=this.getPrecision();var currentBounds=this.map.getBounds();var cluster=this.clusters[precision];for(var type in cluster){var type_cluster=cluster[type];for(var box in type_cluster){var cluster_box=type_cluster[box];var cluster_box_meta=this.getMarkerMeta(cluster_box["cluster"]);if(this.boxInBounds(box,currentBounds,this.opts.padding)){if(cluster_box["cluster"]){if(!cluster_box_meta.hidden&&!cluster_box_meta.visible){for(var i=0,length=cluster_box["markers"].length;i<length;i++){var marker=cluster_box["markers"][i];this.getMarkerMeta(marker).visible=true}cluster_box["cluster"].setMap(this.map);cluster_box["cluster"].setVisible(true);cluster_box_meta.visible=true;this.cluster_meta[type]["count"]["visible"]+=1}}else{var marker=cluster_box["markers"][0];var meta=this.getMarkerMeta(marker);if(!meta.hidden&&!meta.visible){marker.setMap(this.map);marker.setVisible(true);meta.visible=true;this.cluster_meta[type]["count"]["visible"]+=1}}}else{if(cluster_box["cluster"]){cluster_box["cluster"].setVisible(false);if(cluster_box_meta.visible)this.cluster_meta[type]["count"]["visible"]-=1;cluster_box_meta.visible=false}else{for(var i=0,length=cluster_box["markers"].length;i<length;i++){var marker=cluster_box["markers"][i];var meta=this.getMarkerMeta(marker);marker.setVisible(false);if(meta.visible)this.cluster_meta[type]["count"]["visible"]-=1;meta.visible=false}}}}}};ClusterManager.prototype.setClusterFn=function(type,fn){this.cluster_fns[type]=fn};ClusterManager.prototype.setMarkerMeta=function(marker,meta){var defaults=ClusterManager.applyDefaults(meta,marker._cluster_meta);marker._cluster_meta=ClusterManager.applyDefaults(defaults,meta)};ClusterManager.prototype.getMarkerMeta=function(marker){try{return marker._cluster_meta}catch(err){marker._cluster_meta={};return marker._cluster_meta}};ClusterManager.prototype.createClusterIcon=function(number,precision,icon_color,text_color){text_color=text_color||"000000";if(precision>10){var iconOpts={url:"http://chart.apis.google.com/chart?cht=d&chdp=mapsapi&chl=pin%27i\\%27["+number+"%27-2%27f\\hv%27a\\]h\\]o\\"+icon_color+"%27fC\\"+text_color+"%27tC\\000000%27eC\\Lauto%27f\\&ext=.png",size:new google.maps.Size(21,34)}}else{var size=((number+"").length-1)*6+24;var iconOpts={size:new google.maps.Size(size,size),anchor:new google.maps.Point(size/2,size/2),shape:{coord:[size/2,size/2,size/2],type:"circle"},url:"http://chart.apis.google.com/chart?cht=it&chs="+size+"x"+size+"&chco="+icon_color+",000000ff,ffffff01&chl="+number+"&chx="+text_color+",0&chf=bg,s,00000000&ext=.png"}}return this.createMarkerIconOpts(iconOpts)};ClusterManager.prototype.createClusterMarker=function(marker_list,center_lat,center_lng,manager){var htmlEl=document.createElement("div");htmlEl.style.width="400px";function markerClickClosure(marker){return function(e){google.maps.event.trigger(marker,"click",e)}}for(var i=0,marker;marker=marker_list[i];i++){var markerSpan=document.createElement("span");markerSpan.innerHTML="<b>"+manager.getMarkerMeta(marker).summary+"</b><br>";markerSpan.onclick=markerClickClosure(marker);markerSpan.style.color="#334499";markerSpan.style.cursor="pointer";htmlEl.appendChild(markerSpan);if(i>=9)break}if(marker_list.length>10){htmlEl.appendChild(document.createTextNode(marker_list.length-10+" more markers in this area. Zoom in for details."))}var icon_color=manager.opts.icon_color[manager.getMarkerMeta(marker_list[0]).type]||manager.opts.icon_color;var icon=manager.createClusterIcon(marker_list.length,manager.getPrecision(),icon_color);var marker=manager.createMarker({position:new google.maps.LatLng(center_lat,center_lng),title:marker_list.length+" markers",content:htmlEl,summary:marker_list.length+" markers",icon:icon,shape:icon["shape"],zIndex:marker_list.length});return marker};ClusterManager.prototype.createMarkerIconOpts=function(opts){if(typeof opts==="undefined")opts={};if(typeof opts.width==="undefined")opts.width=32;if(typeof opts.height==="undefined")opts.height=32;var width=opts.width,height=opts.height;if(typeof opts.icon_color!=="undefined"){if(typeof opts.icon_color==="object"&&typeof opts.type!=="undefined"){var icon_color=opts.icon_color[opts.type]||"ff0000"}else{var icon_color=opts.icon_color}}else if(typeof opts.type!=="undefined"&&typeof this.opts.icon_color==="object"){var icon_color=this.opts.icon_color[opts.type]||"ff0000"}else{var icon_color=this.opts.icon_color||"ff0000"}if(typeof opts.strokeColor==="undefined")opts.strokeColor="000000";if(typeof opts.cornerColor==="undefined")opts.cornerColor="ffffff";var baseUrl="http://chart.apis.google.com/chart?cht=mm";var iconUrl=baseUrl+"&chs="+width+"x"+height+"&chco="+opts.cornerColor.replace("#","")+","+icon_color+","+opts.strokeColor.replace("#","")+"&ext=.png";return ClusterManager.applyDefaults({url:iconUrl,size:new google.maps.Size(width,height),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(width/2,height)},opts)};ClusterManager.prototype.createMarker=function(opts){var me=this;var defaultIconOpts=this.createMarkerIconOpts(opts);var defaults={map:this.map,visible:false,icon:defaultIconOpts,content:"Marker"};opts=ClusterManager.applyDefaults(defaults,opts);var marker=new google.maps.Marker(opts);if(typeof opts.fn==="undefined"){var iw=new google.maps.InfoWindow({content:opts.content});google.maps.event.addListener(marker,"click",function(){var now=new Date;iw.setZIndex(now.getTime());iw.open(me.map,marker)})}else{google.maps.event.addListener(marker,"click",opts.fn)}this.setMarkerMeta(marker,opts);return marker};ClusterManager.applyDefaults=function(defaults,opts){if(typeof defaults!=="object")return{};if(typeof opts!=="object")return defaults;for(var index in defaults){if(typeof opts[index]==="undefined"){opts[index]=defaults[index]}}return opts};